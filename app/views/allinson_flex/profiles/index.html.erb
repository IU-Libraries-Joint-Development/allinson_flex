<% provide :page_title, t(:'flexible_metadata.dashboard.profiles') %>

<% provide :page_header do %>
  <h1><span class="fa fa-table" aria-hidden="true"></span> <%= t(:'flexible_metadata.index.profiles') %></h1>
  <div class="pull-right">
    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#myModal">
      <span class="fa fa-upload" aria-hidden="true"></span>
      <%= t(:'helpers.action.flexible_metadata_profile.import_profile') %>
    </button>
    <% if @profiles.blank? %>
      <%= link_to flexible_metadata.new_profile_path, class: 'btn btn-primary' do %>
        <span aria-hidden="true"></span> <%= t(:'helpers.action.flexible_metadata_profile.create') %>
      <% end %>
    <% end %>
  </div>
<% end %>

<div class="panel panel-default">
  <div class="panel-body">
    <% if @profiles.present? %>
      <div class="table-responsive">
        <table class="table table-striped datatable">
          <thead>
            <tr>
              <th scope="col">Schema Version</th>
              <th scope="col">Profile Version</th>
              <th scope="col">Profile Type</th>
              <th scope="col">Created At</th>
            </tr>
          </thead>
          <tbody>
            <% @profiles.order("updated_at DESC").each do |flexible_metadata_profile| %>
              <tr>

                <!-- TODO: fix show pgs -->
                <td><%= flexible_metadata_profile.schema_version %></td>
                <td><%= link_to flexible_metadata_profile.profile_version.to_f, flexible_metadata.profile_path(flexible_metadata_profile) %></td>
                <td><%= flexible_metadata_profile.profile_type %></td>
                <td><%= flexible_metadata_profile.created_at.strftime("%b %d, %Y") %></td>
                <% if flexible_metadata_profile == AllinsonFlex::Profile.current_version %>
                  <% if flexible_metadata_profile.locked_at && flexible_metadata_profile.locked_at < Time.now %>
                    <th colspan=3 ><%= link_to raw("<span title='click to force unlock' class='glyphicon glyphicon-lock'></span>"), flexible_metadata.unlock_profile_path(flexible_metadata_profile), method: :post, data: { confirm: 'Are you sure that no other user is editing the profile right now?' } %>
                      <%= flexible_metadata_profile.lock_statement %>
                    </th>

                  <% else %>
                    <th><%= link_to raw('<span class="glyphicon glyphicon-pencil"></span>'), flexible_metadata.edit_profile_path(flexible_metadata_profile), data: { turbolinks: false } %></th>
                    <th><%= link_to raw('<span class="glyphicon glyphicon-download-alt"></span>'), flexible_metadata.profile_export_path(flexible_metadata_profile), tagert: "_blank" %></th>
                    <th><%= link_to raw('<span class="glyphicon glyphicon-remove"></span>'), flexible_metadata.profile_path(flexible_metadata_profile), method: :delete, data: { confirm: 'Are you sure?' } %></th>
                  <% end %>
                <% else %>
                  <td></td>
                  <td></td>
                  <td></td>
                <% end %>
              </tr>
            <% end %>
          </tbody>
        </table>

        <%= page_entries_info @profiles %><br />
        <%= paginate(@profiles, param_name: :profile_entries_page) %>

      </div>
      <% else %>
        <p>No Flexible Metadata Profiles have been created.</p>
      <% end %>
  </div>
</div>


<!-- Modal -->
<div id="myModal" class="modal fade" role="dialog">
  <div class="modal-dialog">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="<%= t('hyrax.dashboard.heading_actions.close') %>"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title"><%= t(:'helpers.action.flexible_metadata_profile.import') %></h4>
      </div>
      <div class="modal-body">
        <%= render 'import_modal' %>
    </div>
  </div>
</div>
